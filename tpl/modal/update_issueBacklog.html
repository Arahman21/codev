
<div id="update_backlog_dialog_form" title="Task XXX - Update Backlog" class="ui-helper-hidden">
   <p class="issue_summary">issue_summary</p>
   <form id="formUpdateBacklog" name="formUpdateBacklog" method="post" action="{$page}" >
      <fieldset>
         <table class="invisible">
            <tbody>
               <tr>
                  <th><label for="status">{t}Status{/t} :</label></th>
                  <td><select id="status" name="status"> </select></td>
                  <td></td>
               </tr>
               <tr id="tr_deadline">
                  <th>{t}Deadline{/t} :</th>
                  <td id="desc_deadline">date</td>
                  <td></td>
               </tr>
               <tr>
                  <th>{t}Estimated Effort{/t} :</th>
                  <td id="desc_effortEstim">effortEstim</td>
                  <td></td>
               </tr>
               <tr>
                  <th>{t}Elapsed{/t} :</th>
                  <td id="desc_elapsed">elapsed</td>
                  <td></td>
               </tr>
               <tr>
                  <th>{t}Backlog{/t} :</th>
                  <td id="desc_currentBacklog" title="{t}Current backlog{/t}"></td>
                  <td></td>
               </tr>
               <tr>
                  <th>{t}Drift{/t} :</th>
                  <td id="desc_drift">drift</td>
                  <td></td>
               </tr>
               <tr>
                  <td colspan="3"><hr></td>
               </tr>
               <tr id="tr_timeToAdd">
                  <th>{t}Time to Add{/t} :</th>
                  <td><select id="timeToAdd" name="timeToAdd" title="{t}Duration (in days){/t}"></select></td>
                  <td></td>
               </tr>
               <tr>
                  <th><label for="backlog">{t}Backlog{/t} :</label></th>
                  <td><input type="text" id="backlog" name="backlog" size="3" class="text" /></td>
                  <td><label id="desc_currentBacklog2" class="help_font" ></label> <label id="validateTips" class="error_font" ></label></td>
               </tr>
            </tbody>
         </table>

         <input type="hidden" name="action" value="unknown" />

         <!-- fields for addTrack action -->
         <input type="hidden" name="bugid"  value="" />
         <input type="hidden" name="trackJobid" value="" />
         <input type="hidden" name="trackUserid" value="" />
         <input type="hidden" name="trackTimestamp" value="" />

         <!-- fields for weekTaskDetails -->
         <input type="hidden" name="weekid" value="{$weekid}" />
         <input type="hidden" name="year" value="{$year}" />

         <input type="hidden" name="statusid" value="" />
         <input type="hidden" name="bugResolvedStatusThreshold" id="bugResolvedStatusThreshold" value="" />
      </fieldset>
   </form>

	<form id="formGetUpdateBacklogData" name="formGetUpdateBacklogData" method="post" action="{$ajaxPage}" >
		<fieldset>
			<input type="hidden" name="action" value="getUpdateBacklogData" />
			<input type="hidden" name="bugid" value="" />
			<input type="hidden" name="trackJobid" value="" />

         <!-- these values will be transmitted to the updateBacklogDialogbox -->
			<input type="hidden" name="trackUserid" value="" />
			<input type="hidden" name="trackDuration" value="" />
			<input type="hidden" name="trackDate" value="" />
		</fieldset>
	</form>
</div>


<script type="text/javascript">

			function getUpdateBacklogData(bugid, jobid, userid, timeToAdd, trackDate) {
			// ajax call to get DialogBox data
			var formGetUpdateBacklogData = jQuery('#formGetUpdateBacklogData');
			jQuery("#formGetUpdateBacklogData").find("input[name=bugid]").val(bugid);
			jQuery("#formGetUpdateBacklogData").find("input[name=trackJobid]").val(jobid);
			jQuery("#formGetUpdateBacklogData").find("input[name=trackUserid]").val(userid);
			jQuery("#formGetUpdateBacklogData").find("input[name=trackDuration]").val(timeToAdd);
			jQuery("#formGetUpdateBacklogData").find("input[name=trackDate]").val(trackDate);

			var deferred = jQuery.Deferred();

			jQuery.ajax({
				type: formGetUpdateBacklogData.attr("method"),
				dataType:"json",
				url: formGetUpdateBacklogData.attr("action"),
				data: formGetUpdateBacklogData.serialize(),
				success: function(data){
					if (null === data) {
console.log('getUpdateBacklogData SUCCESS but null');
						// default failure action
						alert('ERROR UpdateBacklogData is null');
						deferred.reject(); // call the 'fail' callback (if defined)
					} else {
console.log('getUpdateBacklogData SUCCESS ');
						// call the 'done' callback (should be defined)
						deferred.resolve(data);
					}
				},
				error: function(data){
					// default failure action
console.log('getUpdateBacklogData ERROR ' , data);
					alert('ERROR UpdateBacklogData = ' + data);
					deferred.reject(); // call the 'fail' callback (if defined)
				}
			});

			return deferred;
      }


      // This dialog can be opened :
      // 1) when adding a timetrack.
      //   in this case a field with the timetrack will be displayed
      //   so that user can correct the value before setting backlog
      //   and pressing 'OK'
      // 2) on a backlog update without timetrack add
      //    user cannot add time.
		function openUpdateBacklogDialogbox(updateBacklogJsonData) {


         // 1) when adding a timetrack.
         // timeToAdd is set with a nonZero value
         // action has to be set to "addTimetrack"

         // 2) when simple backlog update.
         // timeToAdd = 0
         // action has to be set to "updateBacklog"

			var data = updateBacklogJsonData;

			// do not display computed backlog: force users to reestimate it !
			//jQuery("#backlog").val(data['calculatedBacklog']);

			jQuery("#update_backlog_dialog_form").find(".issue_summary").text(data['summary']);
			jQuery("#desc_effortEstim").text(data['effortEstim']);
			jQuery("#desc_elapsed").text(data['elapsed']);
			jQuery("#desc_currentBacklog").text(data['currentBacklog']);
			jQuery("#desc_currentBacklog2").text('(current = '+data['currentBacklog']+')');
			jQuery("#desc_drift").text(data['drift']);

			if (data.hasOwnProperty("deadline")) {
				jQuery("#desc_deadline").text(data['deadline']);
				jQuery("#tr_deadline").show();
			} else {
				jQuery("#tr_deadline").hide();
			}

			jQuery("#desc_drift").css("backgroundColor", '#' + data['driftColor']);
			jQuery("#formUpdateBacklog").find("input[name=year]").val(jQuery("#year").val());

			jQuery("#formUpdateBacklog").find("input[name=bugid]").val(data['bugid']);
			jQuery("#formUpdateBacklog").find("input[name=statusid]").val(data['currentStatus']);
			jQuery("#formUpdateBacklog").find("input[name=trackJobid]").val(data['trackJobid']);
			jQuery("#formUpdateBacklog").find("input[name=trackUserid]").val(data['trackUserid']);
			jQuery("#formUpdateBacklog").find("input[name=trackTimestamp]").val(data['trackTimestamp']);

         jQuery("#formUpdateBacklog").find("input[name=bugResolvedStatusThreshold]").val(data['bugResolvedStatusThreshold']);

			var dialogBoxTitle = '{t}Task{/t} ' + data['dialogBoxTitle'] + ' - {t}Update Backlog{/t}';
			jQuery("#update_backlog_dialog_form").dialog("option", "title", dialogBoxTitle);

			// set available status
			jQuery('#status').empty();
			var availItemList = data['availableStatusList'];
			for (var id in availItemList) {

				if (availItemList.hasOwnProperty(id)) {
					if (id === data['currentStatus']) {
						jQuery('#status').append(
							jQuery('<option>').attr('id', id).attr('selected', 'selected').append(availItemList[id])
						);
					} else {
						jQuery('#status').append(
							jQuery('<option>').attr('id', id).append(availItemList[id])
						);
					}
				}
			}
			// add eventHandler to update input field
			jQuery('#status').on('change', function() {
				alert('Value change to ' + $(this).attr('value'));
				var selectedStatus = jQuery("#status").children(":selected").attr("id");
				jQuery("#formUpdateBacklog").find("input[name=statusid]").val(selectedStatus);
			});

			// set timeToAdd
			jQuery('#timeToAdd').empty();

         if (0 === data['trackDuration']) {
            $('#tr_timeToAdd').hide();
            jQuery("#formUpdateBacklog").find("input[name=action]").val('updateBacklog');
         } else {
            $('#tr_timeToAdd').show();
            jQuery("#formUpdateBacklog").find("input[name=action]").val('addTimetrack');

            // fill duration combobox values
            var availItemList = data['availableDurationList'];
            for (var id in availItemList) {

               if (availItemList.hasOwnProperty(id)) {
                  if (id === data['trackDuration']) {
                     jQuery('#timeToAdd').append(
                        jQuery('<option>').attr('id', id).attr('selected', 'selected').append(availItemList[id])
                     );
                  } else {
                     jQuery('#timeToAdd').append(
                        jQuery('<option>').attr('id', id).append(availItemList[id])
                     );
                  }
               }
            }
         }
			jQuery("#update_backlog_dialog_form").dialog("open");
		}


	jQuery(document).ready(function() {


		// TODO get #backlog via form.search()
		var backlog = jQuery("#backlog"),
			 tips = jQuery("#validateTips"),
			 allFields = jQuery([]).add(backlog);

		function updateTips(t) {
			tips.text(t);
			//tips.addClass("ui-state-highlight");
			//setTimeout(function() {
			//   tips.removeClass("ui-state-highlight", 1500);
			//}, 500);
		}

		function checkRegexp(o, regexp, n) {
			if (!(regexp.test(o.val()))) {
				o.addClass("ui-state-error");
				updateTips(n);
				return false;
			} else {
				return true;
			}
		}

		function checkStatus(backlog, selectedStatus, bugResolvedStatusThreshold, msg) {
			if ((selectedStatus < bugResolvedStatusThreshold) && (0 == backlog.val())) {
				backlog.addClass("ui-state-error");
				updateTips(msg);
				return false;
			} else {
				return true;
			}
		}

		jQuery("#update_backlog_dialog_form").dialog({
			autoOpen: false,
			//dialogClass: 'no-close',
			height: 'auto',
			width: 500,
			modal: true,
			//closeOnEscape: false,
			open: function() {
				// Select input field contents
				jQuery("#backlog").select();
			},
			buttons: {
				"Update": function() {
					jQuery("#formUpdateBacklog").submit();
				}
				,
				Cancel: function() {
				   jQuery( this ).dialog("close");
				}
			},
			close: function() {
				allFields.val("").removeClass("ui-state-error");
				allFields.css("backgroundColor", "transparent");
            tips.hide(); // the window is reused for BL updates
			}
		});


		function updateBacklog(event) {
console.warn('in function updateBacklog');

		/* stop form from submitting normally */
			event.preventDefault();

			var bValid = true;
			allFields.removeClass("ui-state-error");
			bValid = bValid && checkRegexp(backlog, /^[0-9]+(\.[0-9]5?)?$/i, "format:  '1',  '0.3'  or  '2.55'");

			var bugResolvedStatusThreshold = jQuery("#bugResolvedStatusThreshold").val();
			var selectedStatus = jQuery("#status").children(":selected").attr("id");
			bValid = bValid && checkStatus(backlog, selectedStatus, bugResolvedStatusThreshold, "{t}Task not resolved, backlog cannot be '0'{/t}");


			if (bValid) {
				/* get some values from elements on the page: */
				var formUpdateBacklog = jQuery(this);
				//formUpdateBacklog.find("input[name=year]").val(jQuery("#year").val());
				//formUpdateBacklog.find("input[name=statusid]").val(selectedStatus);

				jQuery.ajax({
					type: formUpdateBacklog.attr("method"),
					url: formUpdateBacklog.attr("action"),
					data: formUpdateBacklog.serialize(),
					success: function(data) {
						jQuery("#weekTaskDetailsDiv").html(jQuery.trim(data));
						updateWidgets("#weekTaskDetailsDiv");
					}
				});

				jQuery("#update_backlog_dialog_form").dialog("close");
			}
		}

		// click on updateBacklog in timesheet
		jQuery('.js-updateBacklog-link').click(function(ev){
			ev.preventDefault();
			var bugid = this.getAttribute('data-bugId');

         var deferred = getUpdateBacklogData(bugid);
			// set success callback: execute openUpdateBacklogDialogbox()


         deferred.done(function(updateBacklogJsonData) {
console.warn('js-updateBacklog-link done');
				jQuery('#formUpdateBacklog').attr('action', '{$ajaxPage}');
				jQuery("#formUpdateBacklog").submit(updateBacklog);
				openUpdateBacklogDialogbox(updateBacklogJsonData);
			});

			// set error callback: execute openUpdateBacklogDialogbox()
         //deferred.fail(function (updateBacklogJsonData) { console.log('fail', updateBacklogJsonData);});

			return false;
		});


		// on page reload (after a click on 'AddTrack' button), raise the updateBacklog dialogBox
		//{if isset($updateBacklogJsonData)}
		//	openUpdateBacklogDialogbox({$updateBacklogJsonData});
		//{/if}

	});

</script>
