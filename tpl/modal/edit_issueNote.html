<!--
This opens a popup window displaying an IssueNote text to edit.

-->

<div id="dialog_editIssueNote" title="Task XXX - Edit timesheet note" class="ui-helper-hidden">

   <label id="editIssueNoteDialogDesc" class="help_font"></label>
   <br><br>

   <div align='left'>
      <form id="formEditIssueNote" name="formEditIssueNote" method="post" action="{$ajaxPage}" >
         <fieldset>
            <textarea id="issuenote_text" name="issuenote_text" cols="80" rows="8"></textarea>
            <input type="hidden" name="action" value="saveIssueNote" />
            <input type="hidden" name="bugid" value="" />
            <input type="hidden" name="issuenoteid" value="" />

            {if isset($userid)}<input type="hidden" name="userid" value="{$userid}" />{/if}
            <input type="hidden" name="weekid" value="{$weekid}" />
            <input type="hidden" name="year" value="{$year}" />
         </fieldset>
      </form>
      <form id="formGetIssueNoteText" name="formGetIssueNoteText" method="get" action="{$ajaxPage}" >
         <fieldset>
            <input type="hidden" name="action" value="getIssueNoteText" />
            <input type="hidden" name="bugid" value="" />
         </fieldset>
      </form>
      <form id="formMarkIssueNoteAsRead" name="formMarkIssueNoteAsRead" method="get" action="{$ajaxPage}" >
         <fieldset>
            <input type="hidden" name="action" value="markIssueNoteAsRead" />
            <input type="hidden" name="bugid" value="" />
         </fieldset>
      </form>
      <form id="formDeleteNote" name="formDeleteNote" method="get" action="{$ajaxPage}" >
         <fieldset>
            <input type="hidden" name="action" value="deleteNote" />
            <input type="hidden" name="bugid" value="" />
            <input type="hidden" name="bugnote_id" value="" />
         </fieldset>
      </form>
   </div>
</div>

<script type="text/javascript">

   // function called when clicked on note icon
   function editIssueNote(bugid){

      // get note via ajax, to be sure that data is up to date.
      var formGetIssueNoteText = jQuery('#formGetIssueNoteText');
      formGetIssueNoteText.find("input[name=bugid]").val(bugid);
      jQuery.ajax({
         type: "GET",
         dataType:"json",
         url: formGetIssueNoteText.attr("action"),
         data: formGetIssueNoteText.serialize(),
         success: function(response) {

            // update dialogbox textarea
            var issuenoteid = response['issuenoteid']
            if (0 !== issuenoteid) {
               var issuenote_text = response['issuenote_text'];
               jQuery("#dialog_editIssueNote").find("textarea[name=issuenote_text]").val(issuenote_text);
            }
            jQuery("#formEditIssueNote").find("input[name=bugid]").val(bugid);
            jQuery("#formEditIssueNote").find("input[name=issuenoteid]").val(issuenoteid);

            var dialogBoxTitle = '{t}Task{/t} ' + bugid + ' - {t}Edit timesheet note{/t}'
            jQuery("#dialog_editIssueNote").dialog("option", "title", dialogBoxTitle);

            jQuery("#editIssueNoteDialogDesc").text("Task " + bugid );

         },
         error: function(data) {
            // TODO
            alert('ERROR: ' + data);
         }
      });

      jQuery("#dialog_editIssueNote").dialog("open");
   }

   function markIssueNoteAsRead(bugid) {
      var formMarkIssueNoteAsRead = jQuery('#formMarkIssueNoteAsRead');
      formMarkIssueNoteAsRead.find("input[name=bugid]").val(bugid);
      jQuery.ajax({
         type: "GET",
         url: formMarkIssueNoteAsRead.attr("action"),
         data: formMarkIssueNoteAsRead.serialize(),
         success: function(data) {

            var img = jQuery("#b_markAsRead_" + bugid);
            img.off('click'); // disable markAsRead link
            img.attr("src","images/b_markAsRead_grey.png");

            var row = jQuery('#issueNotes_tr'+bugid);
            row.css("background-color", "#FFFFFF");

            //alert("Issue " + bugid + ": Note marked as read.");
         },
         error: function(data) {
            // TODO
            alert('ERROR: ' + data);
         }
      });
   }

   function deleteNote(bugid, bugnote_id) {

      // ask delete confirmation
		if (confirm('{t}Delete timesheet note for task {/t}'+bugid+' ?')) {
			
			var formDeleteNote = jQuery('#formDeleteNote');
			formDeleteNote.find("input[name=bugid]").val(bugid);
			formDeleteNote.find("input[name=bugnote_id]").val(bugnote_id);
			jQuery.ajax({
				type: "GET",
				url: formDeleteNote.attr("action"),
				data: formDeleteNote.serialize(),
				success: function(data) {

					// remove IssueNote from DataTable
					var oTable = jQuery('#issueNotes_table').dataTable();
					var row = jQuery('#issueNotes_tr'+bugid).get(0);
					oTable.fnDeleteRow( oTable.fnGetPosition(row) );
					// TODO add {$realname} to column 'readBy_td'

					return false;
				},
				error: function(data) {
					// TODO
					alert('ERROR: ' + data);
				}
			});
		}
   }

   jQuery(document).ready(function() {

      var dialog = jQuery("#dialog_editIssueNote").dialog({
            autoOpen: false,
            modal: true,
            hide: "fade",
            height: 'auto',
            width: "auto",
            closeOnEscape: true,
            buttons: {
               Ok: function() {
                  jQuery("#formEditIssueNote").submit();
                  jQuery("#dialog_editIssueNote").find("textarea[name=issuenote_text]").val('');
                  jQuery("#dialog_editIssueNote").dialog("close");
               },
               Cancel: function() {
                  jQuery("#dialog_editIssueNote").find("textarea[name=issuenote_text]").val('');
                  jQuery( this ).dialog("close");
               }
            }
      });

      // avoid multiple calls to 'submit' by adding the it in a namespace,
      // and removing previous namespace event handler.
      jQuery("#formEditIssueNote").unbind('submit.notes').bind('submit.notes', function(event) {
         /* stop form from submitting normally */
         event.preventDefault();
         /* get some values from elements on the page: */
         var formEditIssueNote = jQuery(this);

         jQuery.ajax({
            type: "GET",
            url: formEditIssueNote.attr("action"),
            data: formEditIssueNote.serialize(),
            success: function(data) {
               // cannot update all tooltips, the complete table must be updated
               jQuery("#weekTaskDetailsDiv").html(jQuery.trim(data));
               updateWidgets("#weekTaskDetailsDiv");
            },
            error: function(data) {
               // TODO
               alert('ERROR: ' + data);
            }
         });
      });

      // click on the IssueNote will raise the editIssueNote dialogbox
      jQuery('.js-add-note-link').click(function(ev){
         var bugId = this.getAttribute('data-bugId');
         ev.preventDefault();
         editIssueNote( bugId );
      });

      // click on markAsRead will add a ReadBy tag to the IssueNote
      jQuery('.js-markNoteAsRead-link').click(function(ev){
         var bugId = this.getAttribute('data-bugId');
         ev.preventDefault();
         markIssueNoteAsRead( bugId );
      });

      // click on deleteBNote to the IssueNote
      jQuery('.js-deleteNote-link').click(function(ev){
         var bugId = this.getAttribute('data-bugId');
         var bugnoteId = this.getAttribute('data-bugnoteId');
         ev.preventDefault();
         deleteNote( bugId, bugnoteId );
      });

   });

</script>
